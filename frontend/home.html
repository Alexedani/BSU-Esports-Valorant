<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Valorant Ranked Tracking Tool</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <img src="esports-arena.webp" alt="Valorant Background" class="background">


  <div class="logo-container">
    <img src="bsu-logo-esports.webp" alt="Boise State Logo" class="logo">
  </div>

  <div class="card">
    <h1>Valorant Ranked Tracking</h1>

    <div class="form-group">
      <input type="text" id="playerName" placeholder="Player Name">
      <input type="text" id="playerTag" placeholder="Tag">
      <button onclick="addPlayer()">Add Player</button>
    </div>

    <h2>Tracked Players</h2>
    <div class="table-container">
      <table id="playersTable">
        <thead>
          <tr>
            <th>Player Name</th>
            <th>Tag</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <!-- Added players shows here -->
        </tbody>
      </table>
    </div>

    <button class="scrape-btn" onclick="runScraper()">Run Scrape Now</button>
    <!-- <p class="scrape-status">Idle</p> -->

    <!--terminal -->
    <div id="terminal"></div>
  </div>

<script>
  const API_BASE = "https://bsu-esports-valorant.onrender.com";

  // ---------------- Players ----------------
  async function addPlayer() {
    const name = document.getElementById("playerName").value.trim();
    const tag = document.getElementById("playerTag").value.trim();
    if (!name || !tag) return alert("Enter both name and tag!");

    await fetch(`${API_BASE}/players`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, tag })
    });

    renderPlayers();
  }

  async function removePlayer(name) {
    await fetch(`${API_BASE}/players/${encodeURIComponent(name)}`, { method: "DELETE" });
    renderPlayers();
  }

  async function renderPlayers() {
    const res = await fetch(`${API_BASE}/players`);
    const players = await res.json();

    const tbody = document.querySelector("#playersTable tbody");
    tbody.innerHTML = "";

    const names = Object.keys(players);
    if (names.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3" class="empty-msg">No players being tracked yet</td></tr>`;
      return;
    }

    names.forEach(name => {
      const row = `
        <tr>
          <td>${name}</td>
          <td>${players[name]}</td>
          <td class="remove-cell">
            <button class="remove-btn" onclick="removePlayer('${name}')">❌</button>
          </td>
        </tr>`;
      tbody.innerHTML += row;
    });
  }

  // ---------------- Scraper ----------------
  let pollInterval;

  function appendLog(msg) {
    const term = document.getElementById("terminal");
    const line = document.createElement("div");
    line.textContent = msg;
    term.appendChild(line);
    // keep only last 20 lines
    if (term.childNodes.length > 20) term.removeChild(term.firstChild);
    term.scrollTop = term.scrollHeight;
  }

  async function runScraper() {
    document.querySelector(".scrape-status").innerText = "Starting scrape...";
    document.getElementById("terminal").innerHTML = "";
    appendLog("▶ Starting scrape...");

    const res = await fetch(`${API_BASE}/run-scraper`, { method: "POST" });
    const data = await res.json();

    if (data.error) {
      document.querySelector(".scrape-status").innerText = "Error: " + data.error;
      appendLog("❌ " + data.error);
      return;
    }

    document.querySelector(".scrape-status").innerText = "Scraping in progress...";
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(checkStatus, 5000);
    checkStatus();
  }

  async function checkStatus() {
    const res = await fetch(`${API_BASE}/scraper-status`);
    const statusData = await res.json();

    if (statusData.logs) {
      document.getElementById("terminal").innerHTML = "";
      statusData.logs.forEach(l => appendLog(l));
    }

    if (statusData.progress) {
      document.querySelector(".scrape-status").innerText =
        `Scraping in progress... ${statusData.progress.current}/${statusData.progress.total}`;
    }

    if (statusData.status === "done") {
      clearInterval(pollInterval);
      document.querySelector(".scrape-status").innerText = "✅ Scrape finished!";
      appendLog("✅ Done!");
    } else if (statusData.status === "error") {
      clearInterval(pollInterval);
      document.querySelector(".scrape-status").innerText = "❌ Error";
      appendLog("❌ Error");
    }
  }

  renderPlayers();
  if (localStorage.getItem("loggedIn") !== "true") {
    window.location.href = "index.html";
  }
</script>
</body>
</html>
