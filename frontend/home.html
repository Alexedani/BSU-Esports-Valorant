<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Valorant Ranked Tracking Tool</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Background -->
  <img src="esports-arena.webp" alt="Valorant Background" class="background">

  <!-- Logo -->
  <div class="logo-container">
    <img src="bsu-logo-esports.webp" alt="Boise State Logo" class="logo">
  </div>

  <!-- TODO:
  add questionmark button for
  what is this tool?
  how to use it?
  where can i see the results?
  Who can i contact if i need help with this? 
  -->
  <!-- Card -->
  <div class="card">
    <h1>Valorant Ranked Tracking</h1>

    <!-- Add Player Form -->
    <div class="form-group">
      <input type="text" id="playerName" placeholder="Player Name">
      <input type="text" id="playerTag" placeholder="Tag">
      <button onclick="addPlayer()">Add Player</button>
    </div>

    <h2>Tracked Players</h2>
    <div class="table-container">
      <table id="playersTable">
        <thead>
          <tr>
            <th>Player Name</th>
            <th>Tag</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <!-- Players will show here -->
        </tbody>
      </table>
    </div>

    <!-- Run Scraper -->
    <button class="scrape-btn" onclick="runScraper()">Run Scrape Now</button>
  </div>

  <!-- Terminal box OUTSIDE card -->
  <div id="terminal"></div>

<script>
  const BASE_URL = "https://bsu-esports-valorant.onrender.com";

  // ---------------- Player Management ----------------
  async function addPlayer() {
    const name = document.getElementById("playerName").value.trim();
    const tag = document.getElementById("playerTag").value.trim();
    if (!name || !tag) {
      return alert("Enter both name and tag!");
    }

    const res = await fetch(`${BASE_URL}/save-player`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, tag })
    });

    if (res.ok) {
      await renderPlayers();
      document.getElementById("playerName").value = "";
      document.getElementById("playerTag").value = "";
    } else {
      alert("Error adding player");
    }
  }

  async function removePlayer(name) {
    const res = await fetch(`${BASE_URL}/remove-player`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name })
    });

    if (res.ok) {
      await renderPlayers();
    } else {
      alert("Error removing player");
    }
  }

  async function renderPlayers() {
    const tbody = document.querySelector("#playersTable tbody");
    tbody.innerHTML = "";

    const res = await fetch(`${BASE_URL}/players`);
    const players = await res.json();

    const names = Object.keys(players);
    if (names.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3" class="empty-msg">No players being tracked yet</td></tr>`;
      return;
    }

    names.forEach((name) => {
      const tag = players[name];
      const row = `
        <tr>
          <td>${name}</td>
          <td>${tag}</td>
          <td class="remove-cell">
            <button class="remove-btn" onclick="removePlayer('${name}')">❌</button>
          </td>
        </tr>`;
      tbody.innerHTML += row;
    });
  }

  // ---------------- Terminal ----------------
  function appendLog(msg) {
    const term = document.getElementById("terminal");
    const line = document.createElement("div");
    line.textContent = msg;
    term.appendChild(line);

    // keep only last ~20 lines
    if (term.childNodes.length > 20) term.removeChild(term.firstChild);

    term.scrollTop = term.scrollHeight;
  }

  // ---------------- Scraper ----------------
  let pollInterval;

  async function runScraper() {
    document.getElementById("terminal").innerHTML = "";
    appendLog("▶ Starting scrape...");

    const res = await fetch(`${BASE_URL}/run-scraper`, { method: "POST" });
    const data = await res.json();

    if (data.error) {
      appendLog("❌ " + data.error);
      return;
    }

    // start polling every 5s
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(checkStatus, 5000);
    checkStatus();
  }

  async function checkStatus() {
    const res = await fetch(`${BASE_URL}/scraper-status`);
    const statusData = await res.json();

    if (statusData.logs) {
      document.getElementById("terminal").innerHTML = "";
      statusData.logs.forEach(l => appendLog(l));
    }

    if (statusData.progress) {
      appendLog(`Progress: ${statusData.progress.current}/${statusData.progress.total} players scraped`);
    }

    if (statusData.status === "done") {
      clearInterval(pollInterval);
      appendLog("✅ Scrape finished!");
    } else if (statusData.status === "error") {
      clearInterval(pollInterval);
      appendLog("❌ Error");
    }
  }

  // Redirect if not logged in
  if (localStorage.getItem("loggedIn") !== "true") {
    window.location.href = "index.html";
  }
  

  // Initial load
  renderPlayers();
</script>
</body>
</html>
