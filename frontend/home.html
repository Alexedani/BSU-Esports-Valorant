<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Valorant Ranked Tracking Tool</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Background image -->
    <img src="esports-arena.webp" alt="Valorant Background" class="background">


  <!-- Logo -->
  <div class="logo-container">
    <img src="bsu-logo-esports.webp" alt="Boise State Logo" class="logo">
  </div>

  <!-- Card -->
  <div class="card">
    <h1>Valorant Ranked Tracking</h1>

    <div class="form-group">
      <input type="text" id="playerName" placeholder="Player Name">
      <input type="text" id="playerTag" placeholder="Tag">
      <button onclick="addPlayer()">Add Player</button>
    </div>

    <h2>Tracked Players</h2>
    <div class="table-container">
      <table id="playersTable">
        <thead>
          <tr>
            <th>Player Name</th>
            <th>Tag</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <!-- Added players will show here -->
        </tbody>
      </table>
    </div>

<button class="scrape-btn" onclick="runScraper()">Run Scrape Now</button>
<p class="scrape-status">Idle</p>

  </div>

<script>
  const API_BASE = "https://bsu-esports-valorant.onrender.com"; // <-- your backend Render URL

  // ---------------- Players ----------------
  async function addPlayer() {
    const name = document.getElementById("playerName").value.trim();
    const tag = document.getElementById("playerTag").value.trim();
    if (!name || !tag) return alert("Enter both name and tag!");

    await fetch(`${API_BASE}/players`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, tag })
    });

    renderPlayers();
  }

  async function removePlayer(name) {
    await fetch(`${API_BASE}/players/${encodeURIComponent(name)}`, {
      method: "DELETE"
    });
    renderPlayers();
  }

  async function renderPlayers() {
    const res = await fetch(`${API_BASE}/players`);
    const players = await res.json();

    const tbody = document.querySelector("#playersTable tbody");
    tbody.innerHTML = "";

    const names = Object.keys(players);
    if (names.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3" class="empty-msg">No players being tracked yet</td></tr>`;
      return;
    }

    names.forEach(name => {
      const row = `
        <tr>
          <td>${name}</td>
          <td>${players[name]}</td>
          <td class="remove-cell">
            <button class="remove-btn" onclick="removePlayer('${name}')">❌</button>
          </td>
        </tr>`;
      tbody.innerHTML += row;
    });
  }

  // ---------------- Scraper ----------------
  let pollInterval;

  async function runScraper() {
    document.querySelector(".scrape-status").innerText = "Starting scrape...";
    const res = await fetch(`${API_BASE}/run-scraper`, { method: "POST" });
    const data = await res.json();

    if (data.error) {
      document.querySelector(".scrape-status").innerText = "Error: " + data.error;
      return;
    }

    document.querySelector(".scrape-status").innerText = "Scraping in progress...";

    // start polling status every 10s
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(checkStatus, 10000);
    checkStatus(); // run immediately too
  }

  async function checkStatus() {
    const res = await fetch(`${API_BASE}/scraper-status`);
    const statusData = await res.json();

    if (statusData.status === "running") {
      document.querySelector(".scrape-status").innerText = "Scraping in progress...";
    } else if (statusData.status === "done") {
      clearInterval(pollInterval);
      document.querySelector(".scrape-status").innerText = "✅ Scrape finished!";
      console.log("Scrape results:", statusData.results);

      // OPTIONAL: display results nicely
      alert("Scrape finished! Check console for results.");
    } else if (statusData.status === "error") {
      clearInterval(pollInterval);
      document.querySelector(".scrape-status").innerText = "❌ Error: " + (statusData.results?.message || "");
    } else {
      document.querySelector(".scrape-status").innerText = "Idle";
    }
  }

  renderPlayers();
  if (localStorage.getItem("loggedIn") !== "true") {
    window.location.href = "index.html";
  }
</script>




</body>
</html>
